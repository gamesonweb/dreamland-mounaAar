"use strict";(self.webpackChunkgameland=self.webpackChunkgameland||[]).push([[792],{512:(e,s,t)=>{t(9981);var i=t(6009);const n={"roi-blanc":["e1"],"reine-blanc":["d1"],"tour-blanc":["a1","h1"],"fou-blanc":["c1","f1"],"cavalier-blanc":["b1","g1"],"pion-blanc":["a2","b2","c2","d2","e2","f2","g2","h2"],"roi-noir":["e8"],"reine-noir":["d8"],"tour-noir":["a8","h8"],"fou-noir":["c8","f8"],"cavalier-noir":["b8","g8"],"pion-noir":["a7","b7","c7","d7","e7","f7","g7","h7"]},a=new Set(["roi-blanc","reine-blanc","fou-blanc","roi-noir","reine-noir","fou-noir"]);var o=t(2999);let c=null,l=null;function r(e,s){c||(c=new i.cj$("hlPiece",e)),c.removeAllMeshes(),s&&c.addMesh(s,s.name.includes("blanc")?i.v9j.White():i.v9j.Magenta())}function h(e,s){l||(l=new i.cj$("hlSquare",e)),l.removeAllMeshes(),s&&s.length>0&&s.forEach((e=>l.addMesh(e,i.v9j.Yellow())))}class u{constructor(e,s,t,n){this.scene=e,this.caseMeshes=s,this.casePositions=t,this.turn=n,this.turnHasChanged=!1,this.selectedMesh=null,this.chess=new o.d$,this.chess.reset(),console.log("État initial du plateau :",this.chess.ascii()),this.hlPiece=new i.cj$("hlPiece",e),this.hlSquare=new i.cj$("hlSquare",e)}selectPiece(e){this.selectedMesh=e;const s=e.name.split("-")[2];console.log(`Sélection de ${e.name}, from: ${s}, position réelle: x:${e.position.x}, z:${e.position.z}`);const t=this.chess.moves({square:s,verbose:!0});return console.log(`Coups possibles pour ${e.name} :`,t.map((e=>e.to))),t.map((e=>e.to))}tryMove(e){if(!this.selectedMesh)return console.log("Aucune pièce sélectionnée pour le déplacement."),null;const s=this.selectedMesh.name.split("-")[2],t=e;console.log("État du plateau avant coup :",this.chess.ascii()),console.log("Tentative de coup :",{from:s,to:t});let i=this.chess.move({from:s,to:t});if(i)return i;const n=e[1];if(this.selectedMesh.name.startsWith("pion-")&&("8"===n||"1"===n))try{i=this.chess.move({from:s,to:t,promotion:"q"})}catch(e){console.log("Erreur de promotion :",e.message)}return i||console.log("Coup invalide :",{from:s,to:t}),i||null}computerPlay(){const e=this.chess.moves({verbose:!0});if(0===e.length)return null;const s=e[Math.floor(Math.random()*e.length)];return this.chess.move(s),console.log("Coup IA joué :",s),s}handlePick(e){const s=e.name;if(/^[a-z]+-(blanc|noir)-[a-h][1-8]$/.test(s)){const t=s.split("-")[1];if("white"===this.turn&&"blanc"!==t||"black"===this.turn&&"noir"!==t)return console.log(`Tour incorrect : ${this.turn} ne peut pas jouer ${t}`),!1;if(this.selectedMesh&&this.selectedMesh.name===s)return console.log("Pièce déjà sélectionnée, annulation de la sélection."),r(this.scene,null),h(this.scene,[]),this.selectedMesh=null,!1;r(this.scene,e);const i=this.selectPiece(e).map((e=>this.caseMeshes[e])).filter((e=>e));return h(this.scene,i),!1}if(this.selectedMesh&&/^[a-h][1-8]$/.test(s)){if(!this.tryMove(s))return console.log("Coup invalide vers",s),!1;const[e,t]=this.selectedMesh.name.split("-"),i=`${e}-${t}-${s}`;return this.selectedMesh.name=i,this.selectedMesh.position=this.casePositions[s].clone(),console.log(`Pièce déplacée : ${i}`),r(this.scene,null),h(this.scene,[]),this.selectedMesh=null,this.turn="white"===this.turn?"black":"white",this.turnHasChanged=!0,!0}return this.selectedMesh&&(console.log("Clic hors pièce ou case valide, désélection."),r(this.scene,null),h(this.scene,[]),this.selectedMesh=null),!1}playAI(){const e=this.computerPlay();if(!e)return;const s={p:"pion",r:"tour",n:"cavalier",b:"fou",q:"reine",k:"roi"}[e.piece],t="w"===e.color?"blanc":"noir",i=`${s}-${t}-${e.from}`,n=`${s}-${t}-${e.to}`,a=this.scene.getMeshByName(i);a&&(a.name=n,a.position=this.casePositions[e.to].clone(),console.log(`IA déplace ${i} vers ${n}`)),this.turn="white"===this.turn?"black":"white",this.turnHasChanged=!1}}class d{constructor(e,s="white"){this.playerColor=s;const t="string"==typeof e?document.getElementById(e):e;if(!(t instanceof HTMLCanvasElement))throw new Error("Game: attendu un <canvas> ou son id");this.engine=new i.N$8(t,!0),this.scene=new i.Z58(this.engine),this.isProcessingClick=!1;const o=i.Pq0.Zero();this.camera=new i.Lqh("cam",Math.PI/2,Math.PI/3.3,15,o,this.scene),this.camera.attachControl(t,!0),this.camera.lowerRadiusLimit=10,this.camera.upperRadiusLimit=55,this.camera.lowerBetaLimit=.5,this.camera.upperBetaLimit=Math.PI/2;const c=Math.PI/2;this.camera.lowerAlphaLimit=Math.PI/2-c/2,this.camera.upperAlphaLimit=Math.PI/2+c/2,this.camera.panningSensibility=0,new i.g4z("hemi",i.Pq0.Up(),this.scene).intensity=.5;const l=new i.ZyN("dir",new i.Pq0(-1,-2,-1).normalize(),this.scene);l.intensity=1.2,this.shadowGen=new i.owA(1024,l),this.shadowGen.usePoissonSampling=!0,this.caseMeshes={},this.casePositions={},i.cng.ImportMesh("","./public/assets/models/","./echec.glb",this.scene,(e=>{e.forEach((s=>{if(!(s instanceof i.uDc))return;const t=s.name;if(/^[a-h][1-8]$/.test(t)){s.isPickable=!0,this.caseMeshes[t]=s;const n=s.getBoundingInfo().boundingBox.centerWorld.clone();e.forEach((e=>{if(!(e instanceof i.uDc))return;const s=e.name;if(/^[a-h][1-8]$/.test(s)){e.isPickable=!0,this.caseMeshes[s]=e;const t=e.getBoundingInfo().boundingBox.centerWorld.clone();this.casePositions[s]=new i.Pq0(-t.x,t.y,t.z),console.log(`Case ${s} positionnée à x:${t.x}, y:${t.y}, z:${t.z}`)}})),console.log(`Case ${t} positionnée à x:${n.x}, y:${n.y}, z:${n.z}`)}}));const s=this.casePositions.a2,t=this.casePositions.h2;var o,c,l;console.log(`Position de a2 : x:${s.x}, z:${s.z}`),console.log(`Position de h2 : x:${t.x}, z:${t.z}`),o=this.scene,c=this.casePositions,l=this.shadowGen,i.cng.ImportMesh("","./public/assets/models/","./pieces.glb",o,(e=>{e.forEach((e=>{e.isVisible=!1,e.isPickable=!1})),Object.entries(n).forEach((([s,t])=>{const n=e.find((e=>e.name===s));if(!n)return void console.warn(`Prototype manquant : ${s}`);const o=n.getBoundingInfo().boundingBox,r=a.has(s)?o.extendSizeWorld.y:0;t.forEach((e=>{const t=c[e];if(!t)return void console.warn(`Pas de position pour ${e}`);const a=n.clone(`${s}-${e}`);a.isVisible=!0,a.isPickable=!0,a.position=new i.Pq0(t.x+2,t.y+r,t.z+.5),console.log(`Pièce ${a.name} placée à ${e} (x:${t.x}, y:${t.y}, z:${t.z})`),l.addShadowCaster(a,!0)}))}))})),this.player=new u(this.scene,this.caseMeshes,this.casePositions,this.playerColor),this.scene.onPointerObservable.add((e=>{if(e.type!==i.Zph.POINTERPICK||!e.pickInfo.hit)return;if(this.isProcessingClick)return;this.isProcessingClick=!0;const s=e.pickInfo.pickedMesh;s?(console.log("Clic sur :",s.name),this.player.handlePick(s)&&this.player.turnHasChanged&&(this.player.turnHasChanged=!1,this.player.playAI()),this.isProcessingClick=!1):this.isProcessingClick=!1}))})),this.engine.runRenderLoop((()=>this.scene.render())),window.addEventListener("resize",(()=>this.engine.resize()))}toggleTopDownView(){if(this.camera){if(this._topDown=!this._topDown,this._topDown){const e=80,s=.05;this.camera.lowerBetaLimit=this.camera.upperBetaLimit=s,this.camera.lowerRadiusLimit=this.camera.upperRadiusLimit=e,this.camera.beta=s,this.camera.radius=e,this.camera.lowerAlphaLimit=this.camera.upperAlphaLimit=this.camera.alpha,this.camera.panningSensibility=0}else{const e=this._camState||{};this.camera.alpha=e.alpha||Math.PI/2,this.camera.beta=e.beta||Math.PI/3.3,this.camera.radius=e.radius||15,this.camera.lowerAlphaLimit=e.lowerAlphaLimit||Math.PI/2-Math.PI/4,this.camera.upperAlphaLimit=e.upperAlphaLimit||Math.PI/2+Math.PI/4,this.camera.lowerBetaLimit=e.lowerBetaLimit||.5,this.camera.upperBetaLimit=e.upperBetaLimit||Math.PI/2,this.camera.lowerRadiusLimit=e.lowerRadiusLimit||10,this.camera.upperRadiusLimit=e.upperRadiusLimit||55,this.camera.panningSensibility=e.panningSensibility||0}this._camState={alpha:this.camera.alpha,beta:this.camera.beta,radius:this.camera.radius,lowerAlphaLimit:this.camera.lowerAlphaLimit,upperAlphaLimit:this.camera.upperAlphaLimit,lowerBetaLimit:this.camera.lowerBetaLimit,upperBetaLimit:this.camera.upperBetaLimit,lowerRadiusLimit:this.camera.lowerRadiusLimit,upperRadiusLimit:this.camera.upperRadiusLimit,panningSensibility:this.camera.panningSensibility}}}}const m=t.p+"32928ad7fdff2848653c45fed5a7d853.mp3";class p{Musics=Object.freeze({GAME_MUSIC:1,GAME_OVER_MUSIC:2});musics=[];sounds=[];previousMusic=-1;musicEnabled=!0;soundEnabled=!0;scene=null;static get instance(){return globalThis[Symbol.for(`PF_${p.name}`)]||new p}async init(e){this.scene=e,await this.loadAssets(),this.playMusic(this.Musics.GAME_MUSIC)}playMusic(e){if(!this.musicEnabled||!this.scene)return!1;-1!==this.previousMusic&&(this.musics[this.previousMusic]?.stop(),this.previousMusic=-1);const s=this.musics[e];return!!s&&(s.play(),this.previousMusic=e,!0)}playSound(e,s=!1){if(!this.soundEnabled||!this.scene)return;const t=this.sounds[e];t&&(t.loop=s,t.play())}setMusicEnabled(e){this.musicEnabled=e,e||-1===this.previousMusic?e&&-1===this.previousMusic&&this.playMusic(this.Musics.GAME_MUSIC):(this.musics[this.previousMusic]?.stop(),this.previousMusic=-1)}setSoundEnabled(e){this.soundEnabled=e}async loadAssets(){if(!this.scene)throw new Error("SoundManager: scene not set");return new Promise(((e,s)=>{const t=new i.rw3(this.scene),n=t.addBinaryFileTask("music1",m);t.onFinish=()=>{this.musics[this.Musics.GAME_MUSIC]=new i.ABN("gameMusic",n.data,this.scene,null,{loop:!0,autoplay:!1,volume:.5}),e(!0)},t.onTaskError=(e,t)=>{console.error("Audio task failed",e.name,t),s(!1)},t.load()}))}}const{instance:g}=p;let M=null;async function w(e){document.getElementById("colorOverlay").style.display="none",document.getElementById("renderCanvas").style.display="block",document.getElementById("toggleViewBtn").style.display="block",M=new d("renderCanvas",e),await g.init(M.scene)}document.getElementById("startAdventureBtn").addEventListener("click",(()=>{document.getElementById("homeScreen").style.display="none",document.getElementById("colorOverlay").style.display="flex"})),document.getElementById("btnWhite").addEventListener("click",(()=>w("white"))),document.getElementById("btnBlack").addEventListener("click",(()=>w("black"))),document.getElementById("toggleViewBtn").addEventListener("click",(()=>{M&&M.toggleTopDownView()}));const y=document.getElementById("settingsBtn"),b=document.getElementById("settingsDropdown"),f=document.getElementById("toggleMusic"),P=document.getElementById("toggleSound");f.addEventListener("change",(e=>{g.setMusicEnabled(e.target.checked)})),P.addEventListener("change",(e=>{g.setSoundEnabled(e.target.checked)})),y.addEventListener("click",(e=>{e.stopPropagation(),b.classList.toggle("show")})),document.addEventListener("click",(e=>{settingsContainer.contains(e.target)||b.classList.remove("show")}))}},e=>{e.O(0,[755],(()=>(512,e(e.s=512)))),e.O()}]);
//# sourceMappingURL=main.01c470e300eedcddd191.js.map